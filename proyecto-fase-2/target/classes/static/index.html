<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Robot Runner – Tablero Inicial</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <header class="topbar">
      <h1>Robot Runner</h1>
      <nav>
        <label style="margin-right: 8px; color: #e2e8f0">Pista:</label>
        <select id="trackSelect" class="btn" style="background: #fff; color: #0f172a"></select>
        <a href="/login" class="btn">Configurar Pistas</a>
        <!--div align="right" style="display: inline-block; margin-left: 12px">
          <form th:action="@{/logout}" method="post" style="margin: 0">
            <button type="submit" class="btn btn-logout">Cerrar sesión</button>
          </form>
        </div-->
      </nav>
    </header>

    <main class="layout">
      <section class="board">
        <div id="grid" class="grid" aria-label="tablero"></div>
        <div id="status" class="status" role="status"></div>
        <div class="actions">
          <button id="run" class="btn">Ejecutar</button>
          <button id="reset" class="btn btn-secondary">Reiniciar</button>
        </div>
      </section>

      <aside class="sidebar">
        <h2>Movimientos</h2>
        <div class="controls">
          <button data-move="FWD" class="btn">Adelante</button>
          <button data-move="LEFT" class="btn">Girar Izquierda</button>
          <button data-move="RIGHT" class="btn">Girar Derecha</button>
          <button data-move="LOOP" class="btn">Bucle</button>
        </div>
        <ol id="programList" class="program"></ol>
      </aside>
    </main>

    <footer class="footer"><small>Fase 1 • Robot Runner</small></footer>

    <script src="js/tracks.seed.js"></script>
    <script src="js/state.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/grid.js"></script>
    <script src="js/program.js"></script>
    <script src="js/engine.js"></script>
    <script src="js/ui.index.js"></script>
    <script>
      async function cargarPistasEnSelect() {
        try {
          const res = await fetch("/api/pistas", { credentials: "same-origin" });
          if (!res.ok) throw new Error("GET /api/pistas " + res.status);
          const pistas = await res.json();
          const sel = document.getElementById("trackSelect");
          sel.innerHTML = pistas.map(p => `<option value="${p.id}">${p.nombre}</option>`).join("");

          // Si quieres leer el JSON y configurar el tablero
          sel.addEventListener("change", async () => {
            const id = sel.value;
            const pista = pistas.find(x => x.id == id);
            if (pista) {
              const cfg = JSON.parse(pista.configuracion);
              // TODO: aplica cfg a tu engine (grid, inicio, meta, bloques, etc.)
              console.log("Config cargada:", cfg);
            }
          });

          // Disparar una vez para aplicar el primero
          sel.dispatchEvent(new Event("change"));
        } catch (e) {
          console.error(e);
        }
      }
      cargarPistasEnSelect();
    </script>
  </body>
</html>
